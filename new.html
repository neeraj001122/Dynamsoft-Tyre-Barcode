<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="description"
      content="Read barcodes from camera with Dynamsoft Barcode Reader. Save the processed frames for debugging."
    />
    <meta name="keywords" content="read barcode from camera, debug" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Dynamsoft Barcode Reader Sample - Debug</title>
  </head>

  <body>
    <h1 style="font-size: 1.5em">Read Barcodes from Camera - Debug</h1>
    <button id="btn-start-capturing">start capturing</button>
    <button id="btn-stop-capturing">stop capturing</button>
    <br />
    <div>
      <label for="zoomFactor">Zoom factor: </label>
      <input
        type="number"
        id="zoomFactor"
        min="1"
        max="5"
        value="1"
        step="1"
        style="margin: 10px 0"
      />
      <button onclick="updateZoom()">Apply Zoom</button>
    </div>
    <br />
    <label>Laplacian filter :-</label>
    <label id="filter value"></label>
    <br /><br />
    <div>
      <strong id="FrameHealth"></strong>
    </div>
    <div
      id="div-ui-container"
      style="width: 100%; height: calc(100vh - 200px)"
    ></div>
    <div>
      <strong id="barcodeResult"></strong>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@10.5.3000/dist/dbr.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- If the network is unstable or you prefer to self-host the SDK, uncomment the line below to load it locally -->
    <!-- <script src="../../../distributables/dbr.bundle.js"></script> -->
    <script>
      // eruda.init();

      let filterValue = document.getElementById("filter value");
      let frameHealth = document.getElementById("FrameHealth");
      let zoomFactorInput = document.getElementById("zoomFactor");
      let barcodeResult = document.getElementById("barcodeResult");
      let frameSharpnes;
      let poorFrameCount = 0;

      // Dynamsoft.Core.CoreModule.enableLogging();
      // Dynamsoft.CVR.CaptureVisionRouter._onLog = console.log;
      // Dynamsoft.DCE.CameraEnhancer._onLog = console.log;

      Dynamsoft.License.LicenseManager.initLicense("");

      Dynamsoft.Core.CoreModule.loadWasm(["DBR"]);

      // Store collected frames
      let collectedFrames = [];
      const MAX_FRAMES = 30;

      //calculate the laplacian variance to estimate the image sharpness
      const calculateLaplacianVariance = (canvas) => {
        const context = canvas.getContext("2d");
        const imageData = context.getImageData(
          0,
          0,
          canvas.width,
          canvas.height
        );
        const data = imageData.data;
        const width = imageData.width;
        const height = imageData.height;

        // Convert to grayscale
        const gray = new Uint8ClampedArray(width * height);
        for (let i = 0; i < data.length; i += 4) {
          gray[i / 4] =
            0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        }

        // Apply Laplacian filter
        const laplacian = new Float32Array(width * height);
        const kernel = [0, 1, 0, 1, -4, 1, 0, 1, 0];

        for (let y = 1; y < height - 1; y++) {
          for (let x = 1; x < width - 1; x++) {
            let sum = 0;
            for (let ky = -1; ky <= 1; ky++) {
              for (let kx = -1; kx <= 1; kx++) {
                const pixel = gray[(y + ky) * width + (x + kx)];
                const weight = kernel[(ky + 1) * 3 + (kx + 1)];
                sum += pixel * weight;
              }
            }
            laplacian[y * width + x] = sum;
          }
        }

        // Calculate variance
        let mean = 0;
        for (let i = 0; i < laplacian.length; i++) {
          mean += laplacian[i];
        }
        mean /= laplacian.length;

        let variance = 0;
        for (let i = 0; i < laplacian.length; i++) {
          variance += Math.pow(laplacian[i] - mean, 2);
        }
        variance /= laplacian.length;

        return variance;
      };

      const frameHealthUpdater = async () => {
        const { cameraEnhancer } = await pInit;

        if (frameSharpnes < 300) {
          frameHealth.innerText = "Frame Health: Poor";
          frameHealth.style.color = "red";
          poorFrameCount++;
          if (poorFrameCount >= 25) {
            cameraEnhancer.setZoom({
              factor: cameraEnhancer.getZoomSettings().factor - 1,
            });

            poorFrameCount = 0;
            alert(
              "The captured barcode area is to poor, please reduce the distance, reducing the zoom level by 1."
            );
          }
        } else {
          frameHealth.innerText = "Frame Health: Good";
          frameHealth.style.color = "green";
        }
      };

      //Image Cropper
      const cropByFourPoints = (canvas, points) => {
        const ctx = canvas.getContext("2d");

        // Create a new canvas same size
        const tmpCanvas = document.createElement("canvas");
        tmpCanvas.width = canvas.width;
        tmpCanvas.height = canvas.height;
        const tmpCtx = tmpCanvas.getContext("2d");

        // Clip to polygon
        tmpCtx.beginPath();
        tmpCtx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++)
          tmpCtx.lineTo(points[i].x, points[i].y);
        tmpCtx.closePath();
        tmpCtx.clip();

        // Draw image onto clipped area
        tmpCtx.drawImage(canvas, 0, 0);

        // Get bounding box to crop tight
        const minX = Math.min(...points.map((p) => p.x));
        const maxX = Math.max(...points.map((p) => p.x));
        const minY = Math.min(...points.map((p) => p.y));
        const maxY = Math.max(...points.map((p) => p.y));

        const width = maxX - minX;
        const height = maxY - minY;

        // Create final cropped canvas
        const outCanvas = document.createElement("canvas");
        outCanvas.width = width;
        outCanvas.height = height;
        const outCtx = outCanvas.getContext("2d");
        outCtx.drawImage(
          tmpCanvas,
          minX,
          minY,
          width,
          height,
          0,
          0,
          width,
          height
        );

        return outCanvas;
      };
      //Update zoom logic on the UI
      async function updateZoom() {
        const { cameraEnhancer } = await pInit;

        const zoomInput = document.getElementById("zoomFactor");
        const value = parseFloat(zoomInput.value);

        if (value >= 1 && value <= 10) {
          try {
            await cameraEnhancer.setZoom({
              factor: value,
            });
          } catch (error) {
            console.error("Failed to set zoom:", error);
            alert("Failed to set zoom. Please try again.");
          }
        } else {
          alert("Please enter a value between 1 and 5");
          zoomInput.value = 1;
        }
      }
      // SDK initialization and camera setup along with barcode result handling
      const init = async () => {
        try {
          // Create a `CameraEnhancer` instance for camera control and a `CameraView` instance for UI control.
          const cameraView = await Dynamsoft.DCE.CameraView.createInstance();
          cameraEnhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance(
            cameraView
          );
          await cameraEnhancer.setResolution({ width: 3840, height: 2160 });

          //Set up the scanRegion
          let scanRegion = {
            x: 20,
            y: 25,
            width: 60,
            height: 40,
            isMeasuredInPercentage: true,
          };
          cameraEnhancer.setScanRegion(scanRegion);

          console.log(await cameraEnhancer.getAllCameras());
          // Get default UI and append it to DOM.
          document
            .querySelector("#div-ui-container")
            .append(cameraView.getUIElement());

          // Create a `CaptureVisionRouter` instance and set `CameraEnhancer` instance as its image source.
          const cvRouter =
            await Dynamsoft.CVR.CaptureVisionRouter.createInstance();

          const intermediateResultManager =
            cvRouter.getIntermediateResultManager();

          cvRouter.setInput(cameraEnhancer);

          let ss = await cvRouter.getSimplifiedSettings("ReadDistantBarcodes");
          ss.timeout = 100000;
          ss.minImageCaptureInterval = 100;
          await cvRouter.updateSettings("ReadDistantBarcodes", ss);

          // Define a callback for results.
          const resultReceiver = new Dynamsoft.CVR.CapturedResultReceiver();

          resultReceiver.onCapturedResultReceived = async (result) => {
            resultItems = result.items;
            if (resultItems.length > 0) {
              poorFrameCount = 0; //reset poor frame count on successful detection
              for (let item of resultItems) {
                barcodeResult.textContent = `${item.formatString}: ${item.text}\n\n`;
              }
              cameraEnhancer.close();
              cvRouter.stopCapturing();
            }
          };

          cvRouter.addResultReceiver(resultReceiver);

          // Define a callback for intermediate results for handling the frame sharpness calculation
          const intermediateResultReceiver =
            new Dynamsoft.CVR.IntermediateResultReceiver();

          intermediateResultReceiver.onLocalizedBarcodesReceived = async (
            intermediateResult,
            info
          ) => {
            if (!intermediateResult.localizedBarcodes.length) return;

            const originalImage = intermediateResultManager.getOriginalImage(
              intermediateResult.originalImageHashId
            );

            const canvasImage = originalImage.toCanvas();

            const localizedBarcodes = intermediateResult.localizedBarcodes;

            for (let i = 0; i < localizedBarcodes.length; i++) {
              const barcode = localizedBarcodes[i];

              const croppedImage = cropByFourPoints(
                canvasImage,
                barcode.location.points
              );

              frameSharpnes = calculateLaplacianVariance(croppedImage);

              filterValue.innerText = frameSharpnes.toFixed(2);

              frameHealthUpdater();
            }
          };

          intermediateResultManager.addResultReceiver(
            intermediateResultReceiver
          );

          return {
            cameraView,
            cameraEnhancer,
            cvRouter,
          };
        } catch (ex) {
          let errMsg = ex.message || ex;
          console.error(errMsg);
          alert(errMsg);
        }
      };
      let pInit = init();

      const setMaxZoom = async (cameraEnhancer) => {
        const capabilities = cameraEnhancer.getCapabilities();
        let maxZoom = capabilities?.zoom?.max;
        if (maxZoom) {
          // limit max zoom to 10x baseline
          let minZoom = capabilities?.zoom?.min || 1;
          if (minZoom <= 1) {
            // base zoom level is 1
            if (maxZoom > 10) {
              maxZoom = 10;
            }
          } else {
            // base zoom level is 100
            if (maxZoom > 1000) {
              maxZoom = 1000;
            }
          }
          cameraEnhancer.setZoom({ factor: capabilities.zoom.max });
          zoomFactorInput.value = capabilities.zoom.max;
          zoomFactorInput.max = capabilities.zoom.max;
        }
      };

      document
        .getElementById("btn-start-capturing")
        .addEventListener("click", async () => {
          const { cameraEnhancer, cvRouter, cameraView } = await pInit;

          // Open camera and start scanning barcode.
          await cameraEnhancer.open();

          await setMaxZoom(cameraEnhancer);

          cameraView.setScanLaserVisible(true);
          await cvRouter.startCapturing("ReadDistantBarcodes");
        });

      document
        .getElementById("btn-stop-capturing")
        .addEventListener("click", async () => {
          const { cameraEnhancer, cvRouter, cameraView } = await pInit;

          cvRouter.stopCapturing();
          cameraEnhancer.close();
          cameraView.setScanLaserVisible(false);
          poorFrameCount = 0;
        });
    </script>
  </body>
</html>
